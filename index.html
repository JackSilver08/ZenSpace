<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Zenpacia</title>
    <link rel="stylesheet" href="CSS/index.css" />
    <link
      rel="icon"
      sizes="132x132"
      href="IMG/Zenpacia 4.0.png"
      type="image/x-icon"
    />
  </head>
  <body>
    <header>
      <a href="index.html"><img src="IMG/Zenpacia 4.0.png" alt="Logo" /></a>

      <div class="search-container">
        <input id="search-box" type="search" placeholder="Nh·∫≠p t·ª´ kh√≥a..." />
      </div>

      <div class="action-buttons">
        <div
          id="chat-icon"
          role="button"
          tabindex="0"
          aria-label="M·ªü chat"
          style="cursor: pointer"
        ></div>
        <a href="#" id="thongBaoBtn">
          <img src="IMG/ZenBell.png" alt="Th√¥ng b√°o" />
          <span id="soThongBao" style="color: red; font-weight: bold"></span>
          Th√¥ng b√°o
        </a>

        <button id="openPopupBtn">
          <span class="plus-icon" aria-hidden="true"></span>
          ƒêƒÉng b√†i
        </button>

        <a href="DangNhap.html" id="loginLink">ƒêƒÉng nh·∫≠p</a>
      </div>
      <!-- Ph·∫ßn th√¥ng tin user, m·∫∑c ƒë·ªãnh ·∫©n -->
      <div id="userAvatarDropdown" class="dropdown">
        <div id="userAvatar">
          <img id="userAvatarImg" src="IMG/ZenUser.png" alt="Avatar" />
          <span id="welcomeText">Ch√†o Tu·∫•n!</span>
        </div>

        <div id="dropdownContent">
          <a href="#" id="accountInfoBtn">Th√¥ng tin t√†i kho·∫£n</a>
          <a href="DangNhap.html" id="logoutBtn">ƒêƒÉng xu·∫•t</a>
        </div>
      </div>
    </header>

    <!-- Popup chat -->

    <!-- Form pop-up (·∫©n ban ƒë·∫ßu) -->
    <div
      id="popupOverlay"
      role="dialog"
      aria-modal="true"
      aria-labelledby="popupTitle"
    >
      <div id="popupForm">
        <h3 id="popupTitle">ƒêƒÉng B√†i</h3>
        <form>
          <label for="title">Ti√™u ƒë·ªÅ:</label>
          <input type="text" id="title" name="title" required />

          <label for="content">N·ªôi dung:</label>
          <textarea id="content" name="content" rows="4" required></textarea>

          <div style="text-align: right">
            <button type="submit">G·ª≠i</button>
            <button type="button" id="closePopupBtn">ƒê√≥ng</button>
          </div>
        </form>
      </div>
    </div>
    <!-- Th·∫ª ·∫©n ch·ª©a k·∫øt qu·∫£ API -->
    <div id="response-text" style="display: none"></div>
    <div id="output" style="padding: 10px; color: green"></div>
    <main>
      <h2 style="padding: 10px">B√†i vi·∫øt g·∫ßn ƒë√¢y</h2>
      <div id="danhSachBaiDang" style="padding: 10px"></div>
    </main>
    <!-- Pop-up s·ª≠a b√†i vi·∫øt -->
    <div
      id="popupSuaBai"
      style="
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.4);
        justify-content: center;
        align-items: center;
        z-index: 999;
      "
    >
      <div
        style="
          background: #fff;
          padding: 20px;
          border-radius: 10px;
          width: 450px;
          max-width: 90%;
        "
      >
        <h3>üìù Ch·ªânh s·ª≠a b√†i vi·∫øt</h3>
        <input
          id="popupEditTitle"
          type="text"
          placeholder="Ti√™u ƒë·ªÅ m·ªõi"
          style="
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            font-size: 16px;
          "
        />
        <textarea
          id="popupEditContent"
          rows="5"
          placeholder="N·ªôi dung m·ªõi"
          style="width: 100%; padding: 10px; font-size: 15px"
        ></textarea>
        <div style="text-align: right; margin-top: 10px">
          <button id="btnHuySua">H·ªßy</button>
          <button
            id="btnLuuSua"
            style="background: #2c7be5; color: white; margin-left: 10px"
          >
            L∆∞u
          </button>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const userId = localStorage.getItem("idTaiKhoan");
        const token = localStorage.getItem("token");
        const accountInfoBtn = document.getElementById("accountInfoBtn");
        const avatarImg = document.getElementById("userAvatarImg");
        const welcomeText = document.getElementById("welcomeText");
        const userDropdown = document.getElementById("userAvatarDropdown");
        const danhSach = document.getElementById("danhSachBaiDang");
        // üëâ N·∫øu ch∆∞a ƒëƒÉng nh·∫≠p
        if (!userId || !token) {
          userDropdown.style.display = "none";
          return;
        }

        // üëâ B·ªçc async h√†m x·ª≠ l√Ω th√¥ng tin ng∆∞·ªùi d√πng
        (async () => {
          try {
            const res = await fetch(
              `http://localhost:8080/api/nguoidung/${userId}`,
              {
                headers: { Authorization: "Bearer " + token },
              }
            );
            if (!res.ok) throw new Error("Ph·∫£n h·ªìi kh√¥ng h·ª£p l·ªá");
            const data = await res.json();

            if (!data.success || !data.data?.user) {
              throw new Error(
                data.message || "Kh√¥ng th·ªÉ l·∫•y d·ªØ li·ªáu ng∆∞·ªùi d√πng"
              );
            }

            const user = data.data.user;

            const avatar =
              user.avatar && user.avatar.trim() !== ""
                ? user.avatar
                : "IMG/ZenUser.png";

            avatarImg.src = avatar;
            welcomeText.textContent = `Ch√†o ${user.tenDangNhap || "b·∫°n"}!`;
            userDropdown.style.display = "flex";

            // üëâ T·∫°i ƒë√¢y c√≥ th·ªÉ d√πng `user` an to√†n: m·ªü chat, ki·ªÉm tra quy·ªÅn...
          } catch (err) {
            console.error("‚ùå L·ªói khi t·∫£i th√¥ng tin ng∆∞·ªùi d√πng:", err.message);
            userDropdown.style.display = "none";
          }
        })();

        // üëâ S·ª± ki·ªán click v√†o ·∫£nh ƒë·∫°i di·ªán ‚Üí v·ªÅ trang c√° nh√¢n
        accountInfoBtn.addEventListener("click", (e) => {
          e.preventDefault();
          if (userId) {
            window.location.href = `TaiKhoan.html?id=${userId}`;
          } else {
            alert("Ch∆∞a ƒëƒÉng nh·∫≠p!");
          }
        });

        // üëâ G·ªçi API ƒë·ªÉ t·∫£i danh s√°ch b√†i vi·∫øt
        fetch("http://localhost:8080/LayBaiDang")
          .then((res) => res.json())
          .then((data) => {
            danhSach.innerHTML = "";
            data.forEach((bai) => {
              const button = document.createElement("button");
              button.textContent = bai.tieuDe;
              button.onclick = () => {
                window.location.href = `BaiViet.html?id=${bai.id}`;
              };
              button.className = "btn-tieu-de";
              button.style.cssText = `
          display: block;
          margin-bottom: 10px;
          padding: 12px;
          width: 100%;
          text-align: left;
          font-size: 16px;
          background-color: #fff;
          border: 1px solid #ccc;
          border-radius: 6px;
          cursor: pointer;
        `;
              danhSach.appendChild(button);
            });
          })
          .catch((err) => {
            console.error("‚ùå L·ªói t·∫£i b√†i vi·∫øt:", err);
            danhSach.textContent = "Kh√¥ng th·ªÉ t·∫£i danh s√°ch b√†i vi·∫øt.";
          });
      });
    </script>

    <script src="JS/index.js"></script>
    <script src="JS/DangBai.js"></script>
  </body>
</html>
