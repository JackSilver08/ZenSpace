<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chi ti·∫øt b√†i vi·∫øt | Zenpacia</title>
    <link rel="stylesheet" href="CSS/index.css" />
    <link
      rel="icon"
      sizes="132x132"
      href="IMG/Zenpacia 4.0.png"
      type="image/x-icon"
    />
    <style>
      main {
        max-width: 800px;
        margin: 30px auto;
        padding: 20px;
        background-color: #fff;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      #chiTietBaiDang h2 {
        font-size: 28px;
        color: #2c7be5;
        margin-bottom: 15px;
      }

      #chiTietBaiDang p {
        font-size: 17px;
        line-height: 1.7;
        color: #333;
      }

      .back-link {
        display: inline-block;
        margin-top: 25px;
        color: #2c7be5;
        font-weight: bold;
        text-decoration: none;
      }

      .back-link:hover {
        text-decoration: underline;
      }
      /* Khung ch·ª©a b√¨nh lu·∫≠n */
      /* ========== Ph·∫ßn hi·ªÉn th·ªã b√¨nh lu·∫≠n ========== */
      #binhLuanContainer {
        margin-top: 30px;
        padding: 20px;
        background-color: #fafafa;
        border-radius: 8px;
        border: 1px solid #ddd;
      }

      #binhLuanContainer h3 {
        margin-bottom: 15px;
        font-size: 20px;
        color: #333;
      }

      .comment-item {
        padding: 10px 15px;
        background: #fff;
        border: 1px solid #eee;
        border-radius: 6px;
        margin-bottom: 10px;
        transition: box-shadow 0.2s;
      }

      .comment-item:hover {
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      }

      .comment-item strong {
        color: #2c7be5;
        font-weight: 600;
      }

      .comment-item em {
        color: #999;
        font-size: 13px;
        margin-left: 8px;
      }

      .comment-item p {
        margin: 6px 0 0;
        color: #444;
      }

      /* ========== Form b√¨nh lu·∫≠n ========== */
      #formBinhLuan textarea {
        font-size: 15px;
        border: 1px solid #ccc;
        border-radius: 6px;
        padding: 10px;
        transition: border-color 0.2s;
      }

      #formBinhLuan textarea:focus {
        border-color: #2c7be5;
        outline: none;
      }

      #guiBinhLuanBtn {
        background-color: #2c7be5;
        color: white;
        border: none;
        padding: 8px 16px;
        font-size: 15px;
        border-radius: 6px;
        cursor: pointer;
        transition: background 0.2s;
      }

      #guiBinhLuanBtn:hover {
        background-color: #1a5fd2;
      }
      .btn-xoa-binhluan {
        margin-top: 8px;
        background-color: #f44336;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 14px;
        cursor: pointer;
        transition: background-color 0.2s ease;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .btn-xoa-binhluan:hover {
        background-color: #d32f2f;
      }

      .btn-xoa-binhluan:active {
        transform: scale(0.98);
      }
    </style>
  </head>

  <body>
    <!-- Header gi·ªØ nguy√™n t·ª´ index.html -->
    <header>
      <a href="index.html">
        <img src="IMG/Zenpacia 4.0.png" alt="Logo" />
      </a>

      <div class="search-container">
        <input id="search-box" type="search" placeholder="Nh·∫≠p t·ª´ kh√≥a..." />
      </div>

      <div class="action-buttons">
        <div
          id="chat-icon"
          role="button"
          tabindex="0"
          aria-label="M·ªü chat"
          style="cursor: pointer"
        ></div>
        <a href="#"><img src="IMG/ZenBell.png" alt="Inofication" />Th√¥ng b√°o</a>
        <button id="openPopupBtn">
          <span class="plus-icon" aria-hidden="true"></span>
          ƒêƒÉng b√†i
        </button>

        <a href="DangNhap.html" id="loginLink">ƒêƒÉng nh·∫≠p</a>
      </div>

      <!-- Ph·∫ßn th√¥ng tin user -->
      <div
        id="userAvatar"
        style="display: none; margin-top: 20px; align-items: center"
      >
        <img
          id="userAvatarImg"
          src="IMG/ZenUser.png"
          alt="Avatar"
          width="50"
          height="50"
          style="border-radius: 50%"
        />
        <p id="welcomeText" style="margin-left: 10px; margin-bottom: 0"></p>
        <a href="DangNhap.html">
          <button id="logoutBtn" style="margin-left: 15px">ƒêƒÉng xu·∫•t</button>
        </a>
      </div>
    </header>

    <!-- N·ªôi dung ch√≠nh -->
    <main>
      <div id="chiTietBaiDang">
        <h2 id="tieuDe">ƒêang t·∫£i...</h2>
        <p id="noiDung"></p>
      </div>
      <a href="index.html" class="back-link">‚Üê Quay l·∫°i trang ch·ªß</a>
    </main>
    <hr />
    <!-- B√¨nh lu·∫≠n -->
    <section>
      <!-- Ch·ªâ hi·ªán khi ƒë√£ ƒëƒÉng nh·∫≠p -->
      <div id="formBinhLuan" style="margin-top: 20px; display: none">
        <textarea
          id="noiDungBinhLuan"
          placeholder="Vi·∫øt b√¨nh lu·∫≠n..."
          rows="3"
          style="width: 100%; resize: none"
        ></textarea>
        <button id="guiBinhLuanBtn" style="margin-top: 10px">G·ª≠i</button>
      </div>

      <div id="binhLuanContainer"></div>
    </section>

    <!-- Script l·∫•y d·ªØ li·ªáu b√†i vi·∫øt -->
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const idBaiDang = new URLSearchParams(window.location.search).get("id");
        const isLoggedIn = localStorage.getItem("isLoggedIn") === "true";
        const idTaiKhoan = parseInt(localStorage.getItem("idTaiKhoan"));
        const username = localStorage.getItem("username");
        const avatarUrl =
          localStorage.getItem("avatarUrl") || "/IMG/ZenUser.png";
        const userAvatarImg = document.getElementById("userAvatarImg");
        if (userAvatarImg) {
          userAvatarImg.onerror = () => {
            console.warn("Kh√¥ng load ƒë∆∞·ª£c avatar, d√πng m·∫∑c ƒë·ªãnh");
            userAvatarImg.src = "/IMG/ZenUser.png";
          };
          userAvatarImg.src = avatarUrl;
        }

        // ‚úÖ Avatar v√† ch√†o user
        if (username) {
          const loginLink = document.getElementById("loginLink");
          if (loginLink) loginLink.style.display = "none";

          const welcomeText = document.getElementById("welcomeText");
          if (welcomeText) welcomeText.textContent = `Xin ch√†o, ${username}`;

          const userAvatarImg = document.getElementById("userAvatarImg");
          if (userAvatarImg) {
            const img = new Image();
            img.onload = () => (userAvatarImg.src = avatarUrl);
            img.onerror = () => (userAvatarImg.src = "IMG/ZenUser.png");
            img.src = avatarUrl;
          }
        }

        // ‚úÖ Hi·ªÉn th·ªã chi ti·∫øt b√†i vi·∫øt
        if (idBaiDang) {
          fetch(`http://localhost:8080/api/baiviet/${idBaiDang}`)
            .then((res) => res.json())
            .then((data) => {
              document.getElementById("tieuDe").textContent = data.tieuDe;
              document.getElementById("noiDung").innerHTML = data.noiDung;
            })
            .catch((err) => {
              document.getElementById("chiTietBaiDang").innerHTML =
                "<p style='color:red;'>Kh√¥ng t√¨m th·∫•y b√†i vi·∫øt.</p>";
              console.error("L·ªói:", err);
            });
        }

        const binhLuanContainer = document.getElementById("binhLuanContainer");

        // ‚úÖ Hi·ªÉn th·ªã form b√¨nh lu·∫≠n n·∫øu ƒëƒÉng nh·∫≠p
        if (isLoggedIn && !isNaN(idTaiKhoan)) {
          const formBinhLuan = document.getElementById("formBinhLuan");
          if (formBinhLuan) formBinhLuan.style.display = "block";

          const guiBtn = document.getElementById("guiBinhLuanBtn");
          guiBtn?.addEventListener("click", () => {
            const noiDung = document
              .getElementById("noiDungBinhLuan")
              .value.trim();
            if (!noiDung)
              return alert("N·ªôi dung b√¨nh lu·∫≠n kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng!");

            fetch("http://localhost:8080/api/binhluan", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                idBaiDang: parseInt(idBaiDang),
                idTaiKhoan,
                noiDung,
              }),
            })
              .then((res) => {
                if (!res.ok) throw new Error();
                return res.json();
              })
              .then(() => {
                document.getElementById("noiDungBinhLuan").value = "";
                taiBinhLuan();
              })
              .catch(() => alert("Kh√¥ng g·ª≠i ƒë∆∞·ª£c b√¨nh lu·∫≠n"));
          });
        }

        // ‚úÖ T·∫£i danh s√°ch b√¨nh lu·∫≠n
        function taiBinhLuan() {
          const idNguoiDung =
            parseInt(localStorage.getItem("idTaiKhoan")) || -1;
          fetch(`http://localhost:8080/api/binhluan/${idBaiDang}`)
            .then((res) => res.json())
            .then((data) => {
              if (!Array.isArray(data))
                throw new Error("Sai ƒë·ªãnh d·∫°ng ph·∫£n h·ªìi");

              let html = `<h3>B√¨nh lu·∫≠n (${data.length})</h3><div>`;
              data.forEach((bl) => {
                console.log(
                  "ID ng∆∞·ªùi d√πng:",
                  idNguoiDung,
                  "| BL:",
                  bl.idTaiKhoan
                );

                const isOwnComment = parseInt(bl.idTaiKhoan) === idNguoiDung;
                html += `
        <div class="comment-item" data-id="${bl.id}">
          <strong>${bl.tenDangNhap || "·∫®n danh"}</strong>
          <em>(${new Date(bl.ngayBinhLuan).toLocaleString()})</em>
          <p>${bl.noiDung}</p>
          ${
            isOwnComment
              ? `<button class="btn-xoa-binhluan" title="Xo√° b√¨nh lu·∫≠n c·ªßa b·∫°n">üóë Xo√°</button>`
              : ""
          }
        </div>

        `;
              });

              html += "</div>";
              binhLuanContainer.innerHTML = html;

              document.querySelectorAll(".btn-xoa-binhluan").forEach((btn) => {
                btn.addEventListener("click", async () => {
                  const id = btn.closest(".comment-item").dataset.id;
                  if (!confirm("B·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a b√¨nh lu·∫≠n n√†y?")) return;

                  try {
                    const res = await fetch(
                      `http://localhost:8080/XoaBinhLuan/${id}`,
                      {
                        method: "DELETE",
                        headers: {
                          Authorization:
                            "Bearer " + localStorage.getItem("token"),
                        },
                      }
                    );
                    if (!res.ok) throw new Error(await res.text());
                    alert("ƒê√£ x√≥a b√¨nh lu·∫≠n");
                    taiBinhLuan();
                  } catch (err) {
                    alert("L·ªói: " + err.message);
                  }
                });
              });
            })
            .catch((err) => {
              console.error("L·ªói t·∫£i b√¨nh lu·∫≠n:", err);
              binhLuanContainer.innerHTML = `<p style='color:red;'>Kh√¥ng t·∫£i ƒë∆∞·ª£c b√¨nh lu·∫≠n.</p>`;
            });
        }

        taiBinhLuan();
      });
    </script>
  </body>
</html>
