<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chi ti·∫øt b√†i vi·∫øt | Zen Space</title>
    <link rel="stylesheet" href="CSS/index.css" />
    <link
      rel="icon"
      sizes="132x132"
      href="IMG/ZenSpace.png"
      type="image/x-icon"
    />
    <style>
      main {
        max-width: 800px;
        margin: 30px auto;
        padding: 20px;
        background-color: #fff;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      #chiTietBaiDang h2 {
        font-size: 28px;
        color: #2c7be5;
        margin-bottom: 15px;
      }

      #chiTietBaiDang p {
        font-size: 17px;
        line-height: 1.7;
        color: #333;
      }

      .back-link {
        display: inline-block;
        margin-top: 25px;
        color: #2c7be5;
        font-weight: bold;
        text-decoration: none;
      }

      .back-link:hover {
        text-decoration: underline;
      }
      /* Khung ch·ª©a b√¨nh lu·∫≠n */
      #binhLuanContainer {
        margin-top: 40px;
        padding: 20px;
        border-top: 2px solid #e0e0e0;
        background-color: #fafafa;
        border-radius: 8px;
        font-family: "Segoe UI", sans-serif;
      }

      /* Ti√™u ƒë·ªÅ */
      #binhLuanContainer h3 {
        font-size: 22px;
        color: #2c7be5;
        margin-bottom: 15px;
      }

      /* Form g·ª≠i b√¨nh lu·∫≠n */
      #binhLuanContainer textarea {
        width: 100%;
        padding: 12px;
        border: 1px solid #ccc;
        border-radius: 6px;
        resize: vertical;
        font-size: 15px;
        font-family: inherit;
      }

      #binhLuanContainer button {
        background-color: #2c7be5;
        color: white;
        border: none;
        padding: 10px 18px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 15px;
        margin-top: 10px;
        transition: background-color 0.3s ease;
      }

      #binhLuanContainer button:hover {
        background-color: #1a5dcc;
      }

      /* Danh s√°ch b√¨nh lu·∫≠n */
      #binhLuanContainer .comment-item {
        border-bottom: 1px solid #ddd;
        padding: 10px 0;
      }

      #binhLuanContainer .comment-item:last-child {
        border-bottom: none;
      }

      #binhLuanContainer .comment-item strong {
        color: #333;
      }

      #binhLuanContainer .comment-item em {
        font-size: 0.85em;
        color: #888;
      }

      #binhLuanContainer .comment-item p {
        margin: 5px 0 0;
        font-size: 15px;
        color: #444;
      }
    </style>
  </head>

  <body>
    <!-- Header gi·ªØ nguy√™n t·ª´ index.html -->
    <header>
      <a href="index.html">
        <img src="IMG/ZenSpace.png" alt="Logo" />
      </a>

      <div class="search-container">
        <input id="search-box" type="search" placeholder="Nh·∫≠p t·ª´ kh√≥a..." />
      </div>

      <div class="action-buttons">
        <div
          id="chat-icon"
          role="button"
          tabindex="0"
          aria-label="M·ªü chat"
          style="cursor: pointer"
        ></div>
        <a href="#"
          ><img src="IMG/ZenBell.png" alt="Inofication" />Th√¥ng b√°o</a
        >
        <button id="openPopupBtn">
          <span class="plus-icon" aria-hidden="true"></span>
          ƒêƒÉng b√†i
        </button>

        <a href="DangNhap.html" id="loginLink">ƒêƒÉng nh·∫≠p</a>

      </div>

      <!-- Ph·∫ßn th√¥ng tin user -->
      <div
        id="userAvatar"
        style="display: none; margin-top: 20px; align-items: center"
      >
        <img
          id="userAvatarImg"
          src="IMG/ZenUser.png"
          alt="Avatar"
          width="50"
          height="50"
          style="border-radius: 50%"
        />
        <p id="welcomeText" style="margin-left: 10px; margin-bottom: 0"></p>
        <a href="DangNhap.html">
          <button id="logoutBtn" style="margin-left: 15px">ƒêƒÉng xu·∫•t</button>
        </a>
      </div>
    </header>

    <!-- N·ªôi dung ch√≠nh -->
    <main>
      <div id="chiTietBaiDang">
        <h2 id="tieuDe">ƒêang t·∫£i...</h2>
        <p id="noiDung"></p>
      </div>
      <a href="index.html" class="back-link">‚Üê Quay l·∫°i trang ch·ªß</a>
    </main>
    <hr />
   
      <!-- Ch·ªâ hi·ªán khi ƒë√£ ƒëƒÉng nh·∫≠p -->
      <div id="formBinhLuan" style="margin-top: 20px; display: none">
        <textarea
          id="noiDungBinhLuan"
          placeholder="Vi·∫øt b√¨nh lu·∫≠n..."
          rows="3"
          style="width: 100%; resize: none"
        ></textarea>
        <button id="guiBinhLuanBtn" style="margin-top: 10px">G·ª≠i</button>
      </div>
    </section>

    <!-- Script l·∫•y d·ªØ li·ªáu b√†i vi·∫øt -->
    <script>
document.addEventListener("DOMContentLoaded", () => {
  const idBaiDang = new URLSearchParams(window.location.search).get("id");
  const isLoggedIn = localStorage.getItem("isLoggedIn") === "true";
  const rawIdTaiKhoan = localStorage.getItem("idTaiKhoan");
  const idTaiKhoan = parseInt(rawIdTaiKhoan);
  const username = localStorage.getItem("username");
  const avatarUrl = localStorage.getItem("avatarUrl") || "../IMG/ZenUser.png";

  const main = document.querySelector("main");
  const binhLuanContainer = document.createElement("div");
  binhLuanContainer.id = "binhLuanContainer";
  main.appendChild(binhLuanContainer);

  // ‚úÖ Avatar v√† t√™n user
  const loginLink = document.getElementById("loginLink");
  if (username && loginLink) loginLink.style.display = "none";

  const userAvatarImg = document.getElementById("userAvatarImg");

    function preloadImage(url, onSuccess, onError) {
      const img = new Image();
      img.onload = () => onSuccess(url);
      img.onerror = () => onError();
      userAvatarImg.src = "IMG/ZenUser.png";
    }

    if (userAvatarImg) {
      preloadImage(
        avatarUrl,
        (validUrl) => {
          userAvatarImg.src = validUrl;
        },
        () => {
          userAvatarImg.src = "IMG/ZenUser.png";
        }
      );
    }

  const welcomeText = document.getElementById("welcomeText");
  if (welcomeText) welcomeText.textContent = `Xin ch√†o, ${username}`;

  // ‚úÖ Chi ti·∫øt b√†i vi·∫øt
  if (idBaiDang) {
    fetch(`http://localhost:8080/api/baiviet/${idBaiDang}`)
      .then((res) => res.json())
      .then((data) => {
        document.getElementById("tieuDe").textContent = data.tieuDe;
        document.getElementById("noiDung").textContent = data.noiDung;
      })
      .catch((err) => {
        document.getElementById("chiTietBaiDang").innerHTML =
          "<p style='color:red;'>Kh√¥ng t√¨m th·∫•y b√†i vi·∫øt.</p>";
        console.error("L·ªói:", err);
      });
  }

  // ‚úÖ N·∫øu ƒë√£ ƒëƒÉng nh·∫≠p h·ª£p l·ªá ‚Üí hi·ªán form b√¨nh lu·∫≠n
  if (isLoggedIn && !isNaN(idTaiKhoan)) {
    const formHTML = `
      <h3>Vi·∫øt b√¨nh lu·∫≠n:</h3>
      <textarea id="noiDungBinhLuan" placeholder="Nh·∫≠p n·ªôi dung..." rows="3" style="width: 100%; padding: 10px;"></textarea>
      <button id="guiBinhLuanBtn" style="margin-top: 10px;">G·ª≠i b√¨nh lu·∫≠n</button>
    `;
    binhLuanContainer.insertAdjacentHTML("beforeend", formHTML);

    document.getElementById("guiBinhLuanBtn").addEventListener("click", () => {
      const noiDung = document.getElementById("noiDungBinhLuan").value.trim();
      if (!noiDung) {
        alert("N·ªôi dung b√¨nh lu·∫≠n kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng!");
        return;
      }

      const payload = {
        idBaiDang: parseInt(idBaiDang),
        idTaiKhoan: idTaiKhoan,
        noiDung: noiDung,
      };

      console.log("üöÄ G·ª≠i payload:", payload);

      fetch("http://localhost:8080/api/binhluan", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      })
        .then((res) => {
          if (!res.ok) throw new Error("Kh√¥ng g·ª≠i ƒë∆∞·ª£c b√¨nh lu·∫≠n");
          return res.json();
        })
        .then(() => {
          document.getElementById("noiDungBinhLuan").value = "";
          taiBinhLuan();
        })
        .catch((err) => {
          console.error("L·ªói:", err);
          alert("G·ª≠i b√¨nh lu·∫≠n th·∫•t b·∫°i.");
        });
    });
  } else if (isLoggedIn) {
    binhLuanContainer.innerHTML = `<p style="color:red;">Kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ª£c ID t√†i kho·∫£n. B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p l·∫°i.</p>`;
  }

  // ‚úÖ H√†m t·∫£i b√¨nh lu·∫≠n
  function taiBinhLuan() {
    fetch(`http://localhost:8080/api/binhluan/${idBaiDang}`)
      .then((res) => res.json())
      .then((data) => {
        if (!Array.isArray(data)) throw new Error("Ph·∫£n h·ªìi kh√¥ng h·ª£p l·ªá");
        let html = `<h3>B√¨nh lu·∫≠n (${data.length})</h3><div>`;
        data.forEach((bl) => {
          html += `
            <div class="comment-item">
              <strong>${bl.tenDangNhap || "·∫®n danh"}</strong> 
              <em>(${new Date(bl.ngayBinhLuan).toLocaleString()})</em>
              <p>${bl.noiDung}</p>
            </div>
          `;
        });
        html += "</div>";
        document
          .getElementById("binhLuanContainer")
          .insertAdjacentHTML("beforeend", html);
      })
      .catch((err) => {
        console.error("L·ªói t·∫£i b√¨nh lu·∫≠n:", err);
        binhLuanContainer.innerHTML = `<p style='color:red;'>Kh√¥ng t·∫£i ƒë∆∞·ª£c b√¨nh lu·∫≠n.</p>`;
      });
  }

  taiBinhLuan();
});

</script>

  </body>
</html>
