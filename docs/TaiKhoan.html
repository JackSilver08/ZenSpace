<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Th√¥ng tin t√†i kho·∫£n - Zen Space</title>
    <link rel="stylesheet" href="CSS/TaiKhoan.css" />
    <link
      rel="icon"
      sizes="132x132"
      href="IMG/Zenpacia 4.0.png"
      type="image/x-icon"
    />
  </head>
  <body>
    <div id="profilePage">
      <h2>Th√¥ng tin t√†i kho·∫£n</h2>

      <!-- ·∫¢nh ƒë·∫°i di·ªán -->
      <div id="profile-avatar">
        <img
          src="IMG/ZenUser.png"
          id="profileAvatarImg"
          alt="Avatar ng∆∞·ªùi d√πng"
          width="150"
          height="150"
          style="object-fit: cover; border-radius: 50%"
        />
        <input type="file" id="changeAvatarInput" style="display: none" />
      </div>

      <!-- T√™n ng∆∞·ªùi d√πng -->
      <p>
        <strong>T√™n ng∆∞·ªùi d√πng:</strong>
        <span id="profileUsername">ƒêang t·∫£i...</span>
      </p>

      <!-- B√†i vi·∫øt -->
      <div id="userPosts">
        <h3>B√†i vi·∫øt c·ªßa b·∫°n</h3>
        <ul id="postList">
          <li>ƒêang t·∫£i b√†i vi·∫øt...</li>
        </ul>
      </div>
      <div id="chatContainer" style="margin-top: 10px; display: none">
        <button id="btnMoChat">üí¨ Nh·∫Øn tin</button>
      </div>

      <div class="admin-controls" id="adminControls" style="display: none">
        <button id="btnXoaTaiKhoan">X√≥a t√†i kho·∫£n n√†y</button>
      </div>
    </div>
    <div
      id="chatPopup"
      style="
        display: none;
        position: fixed;
        bottom: 80px;
        right: 30px;
        width: 320px;
        background: white;
        border: 1px solid #ccc;
        border-radius: 8px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        z-index: 999;
      "
    >
      <div style="padding: 10px; background: #eee; font-weight: bold">
        üì® Chat v·ªõi <span id="chatTenNguoiNhan">...</span>
        <button
          style="float: right"
          onclick="document.getElementById('chatPopup').style.display='none'"
        >
          ‚úñ
        </button>
      </div>
      <div
        id="chatNoiDung"
        style="
          max-height: 200px;
          overflow-y: auto;
          padding: 10px;
          font-size: 14px;
        "
      ></div>
      <div style="display: flex; padding: 10px; gap: 5px">
        <input
          id="chatInput"
          placeholder="Nh·∫≠p tin nh·∫Øn..."
          style="flex: 1; padding: 5px"
        />
        <button id="btnGuiChat">G·ª≠i</button>
      </div>
    </div>

    <script>
      (function () {
        const userId = new URLSearchParams(window.location.search).get("id");
        if (!userId) {
          alert("Thi·∫øu ID ng∆∞·ªùi d√πng.");
          window.location.href = "index.html";
          return;
        }

        const currentUserId = localStorage.getItem("idTaiKhoan");
        const currentUserRole = localStorage.getItem("role");
        const token = localStorage.getItem("token");

        function fetchWithAuth(url, options = {}) {
          options.headers = options.headers || {};
          if (token) {
            options.headers["Authorization"] = "Bearer " + token;
          }
          return fetch(url, options);
        }

        // üîÑ L·∫•y d·ªØ li·ªáu ng∆∞·ªùi d√πng & b√†i vi·∫øt
        fetchWithAuth(`http://127.0.0.1:8080/api/nguoidung/${userId}`)
          .then((res) => {
            if (!res.ok) throw new Error("Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi d√πng.");
            return res.json();
          })
          .then((data) => {
            if (!data.success || !data.data?.user) {
              throw new Error(data.message || "D·ªØ li·ªáu tr·∫£ v·ªÅ kh√¥ng h·ª£p l·ªá");
            }

            const user = data.data.user;
            const posts = data.data.baiViets || [];

            // üëâ Hi·ªÉn th·ªã th√¥ng tin
            const avatar =
              user.avatar?.trim() !== "" ? user.avatar : "IMG/ZenUser.png";
            document.getElementById("profileUsername").textContent =
              user.tenDangNhap;
            document.getElementById("profileAvatarImg").src = avatar;

            // üëâ Danh s√°ch b√†i vi·∫øt
            const postList = document.getElementById("postList");
            postList.innerHTML = posts.length
              ? ""
              : "<li>Ch∆∞a c√≥ b√†i vi·∫øt n√†o.</li>";
            posts.forEach((post) => {
              const li = document.createElement("li");
              const ngayDang = post.ngayDang
                ? new Date(post.ngayDang).toLocaleString("vi-VN")
                : "";
              li.textContent = `${post.tieuDe} (${ngayDang}): ${post.noiDung}`;
              postList.appendChild(li);
            });

            // üëâ Hi·ªán n√∫t X√≥a n·∫øu l√† admin
            if (
              currentUserRole === "admin" &&
              currentUserId &&
              currentUserId !== user.id.toString()
            ) {
              const btnXoa = document.getElementById("btnXoaTaiKhoan");
              const controls = document.getElementById("adminControls");
              controls.style.display = "block";
              btnXoa.addEventListener("click", () => {
                if (confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a t√†i kho·∫£n n√†y kh√¥ng?")) {
                  fetchWithAuth(
                    `http://localhost:8080/api/xoataikhoan/${user.id}`,
                    {
                      method: "DELETE",
                    }
                  )
                    .then((res) => {
                      if (res.ok) {
                        alert("‚úÖ ƒê√£ x√≥a t√†i kho·∫£n.");
                        window.location.href = "index.html";
                      } else {
                        return res.json().then((j) => {
                          alert(j.message || "‚ùå Kh√¥ng th·ªÉ x√≥a t√†i kho·∫£n.");
                        });
                      }
                    })
                    .catch(() => alert("‚ùå L·ªói khi g·ª≠i y√™u c·∫ßu x√≥a."));
                }
              });
            }

            if (currentUserId !== user.id.toString()) {
              document.getElementById("chatContainer").style.display = "block";
              const chatButton = document.getElementById("btnMoChat");
              const chatPopup = document.getElementById("chatPopup");
              const chatTen = document.getElementById("chatTenNguoiNhan");
              const chatNoiDung = document.getElementById("chatNoiDung");
              const chatInput = document.getElementById("chatInput");
              const btnGuiChat = document.getElementById("btnGuiChat");

              chatButton.addEventListener("click", () => {
                chatTen.textContent = user.tenDangNhap;
                chatPopup.style.display = "block";
                chatNoiDung.innerHTML =
                  "<p><i>‚è≥ ƒêang t·∫£i l·ªãch s·ª≠ chat...</i></p>";

                fetchWithAuth(
                  `http://localhost:8080/api/chat/lichsu/${currentUserId}/${user.id}`
                )
                  .then((res) => res.json())
                  .then((data) => {
                    chatNoiDung.innerHTML = "";

                    if (
                      Array.isArray(data.tinNhan) &&
                      data.tinNhan.length > 0
                    ) {
                      data.tinNhan.forEach((msg) => {
                        const p = document.createElement("p");
                        p.textContent = `${
                          msg.nguoiGuiID == currentUserId ? "üßç B·∫°n" : "üë§ H·ªç"
                        }: ${msg.noiDung}`;
                        chatNoiDung.appendChild(p);
                      });
                    } else {
                      chatNoiDung.innerHTML =
                        "<p><i>Kh√¥ng c√≥ tin nh·∫Øn n√†o.</i></p>";
                    }
                  })
                  .catch((err) => {
                    console.error("‚ùå L·ªói t·∫£i l·ªãch s·ª≠ chat:", err);
                    chatNoiDung.innerHTML =
                      "<p><i>Kh√¥ng th·ªÉ t·∫£i l·ªãch s·ª≠ chat.</i></p>";
                  });
              });

              btnGuiChat.addEventListener("click", () => {
                const noiDung = chatInput.value.trim();
                if (!noiDung) return;

                const payload = {
                  nguoiGuiID: parseInt(currentUserId),
                  nguoiNhanID: user.id,
                  noiDung: noiDung,
                };

                fetchWithAuth("http://localhost:8080/api/chat/gui", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify(payload),
                })
                  .then((res) => res.json())
                  .then((data) => {
                    if (data.success) {
                      const p = document.createElement("p");
                      p.textContent = `üßç B·∫°n: ${noiDung}`;
                      chatNoiDung.appendChild(p);
                      chatInput.value = "";
                      chatNoiDung.scrollTop = chatNoiDung.scrollHeight;
                    } else {
                      alert(
                        "‚ùå " + (data.message || "Kh√¥ng g·ª≠i ƒë∆∞·ª£c tin nh·∫Øn.")
                      );
                    }
                  })
                  .catch((err) => {
                    console.error("‚ùå L·ªói g·ª≠i tin nh·∫Øn:", err);
                    alert("Kh√¥ng th·ªÉ g·ª≠i tin nh·∫Øn.");
                  });
              });
            }

            // üîô N√∫t quay l·∫°i
            const backButton = document.createElement("button");
            backButton.className = "back-home-button";
            backButton.innerHTML = "‚Üê Quay l·∫°i trang ch·ªß";
            backButton.onclick = () => {
              window.location.href = "index.html";
            };
            document.getElementById("profilePage").appendChild(backButton);
          })
          .catch((err) => {
            alert(err.message || "Kh√¥ng th·ªÉ t·∫£i th√¥ng tin ng∆∞·ªùi d√πng.");
            window.location.href = "index.html";
          });

        // üîÅ ƒê·ªïi avatar
        document
          .getElementById("profileAvatarImg")
          .addEventListener("click", () => {
            document.getElementById("changeAvatarInput").click();
          });

        document
          .getElementById("changeAvatarInput")
          .addEventListener("change", (event) => {
            const file = event.target.files[0];
            if (!file || !file.type.startsWith("image/")) {
              alert("Vui l√≤ng ch·ªçn m·ªôt t·ªáp ·∫£nh h·ª£p l·ªá.");
              return;
            }

            const reader = new FileReader();
            reader.onload = () => {
              const base64 = reader.result;
              fetchWithAuth(
                `http://localhost:8080/api/nguoidung/${userId}/avatar`,
                {
                  method: "PUT",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ avatar: base64 }),
                }
              )
                .then((res) => res.json())
                .then((data) => {
                  if (data.success) {
                    alert("ƒê·ªïi avatar th√†nh c√¥ng!");
                    document.getElementById("profileAvatarImg").src = base64;
                  } else {
                    alert("L·ªói: " + (data.message || "Kh√¥ng th·ªÉ ƒë·ªïi avatar."));
                  }
                })
                .catch(() => alert("L·ªói k·∫øt n·ªëi khi ƒë·ªïi avatar."));
            };

            reader.readAsDataURL(file);
          });
      })();
    </script>
  </body>
</html>
